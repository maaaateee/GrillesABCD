<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur SSIAP - Version ADP</title>
    <style>
        /* --- CSS NATIVE (ZERO DEPENDANCE) --- */
        :root {
            /* Couleurs Slate */
            --bg-body: #f8fafc; 
            --bg-card: #ffffff;
            --text-main: #1e293b; 
            --text-muted: #64748b; 
            --border: #e2e8f0; 
            --nav-bg: rgba(255, 255, 255, 0.95);
            
            /* Couleurs M√©tier */
            --blue: #2563eb; --blue-light: #eff6ff; --blue-text: #1e40af;
            --indigo: #4f46e5; --indigo-light: #eef2ff; --indigo-text: #3730a3;
            --emerald: #10b981; --emerald-light: #ecfdf5; --emerald-text: #065f46;
            --orange: #f97316; --orange-light: #fff7ed; --orange-text: #9a3412;
            --purple: #9333ea; --purple-light: #faf5ff; --purple-text: #6b21a8;
            --red: #ef4444; --red-light: #fef2f2; --red-text: #991b1b;
            --teal: #14b8a6; --teal-light: #f0fdfa; --teal-text: #115e59;

            /* Codes Grille */
            --c-nx01: #1e3a8a; --t-nx01: white;
            --c-j60f: #fef9c3; --t-j60f: #854d0e;
            --c-jfp: #fff1f2; --t-jfp: #9f1239;
            --c-jr: #ecfccb; --t-jr: #3f6212;
            --c-jmc: #ffedd5; --t-jmc: #9a3412;
            --c-jr24: #e0f2fe; --t-jr24: #075985;
            --c-mr1: #f3e8ff; --t-mr1: #6b21a8;
            --c-void: white; --t-void: #cbd5e1;
        }

        html.dark {
            --bg-body: #0f172a; 
            --bg-card: #1e293b; 
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8; 
            --border: #334155; 
            --nav-bg: rgba(15, 23, 42, 0.95);
            --c-void: #334155; --t-void: #64748b;
        }

        * { box-sizing: border-box; }
        body { margin:0; font-family: "Segoe UI", system-ui, sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.5; font-size: 14px; }
        
        /* Layout */
        .container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; } .mb-4 { margin-bottom: 1rem; } .mb-8 { margin-bottom: 2rem; }
        .hidden { display: none !important; }

        /* Components */
        .card { background: var(--bg-card); border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; padding: 1.5rem; position: relative; }
        .card:hover { transform: translateY(-2px); transition: transform 0.2s; }
        
        .stat-icon-bg { position: absolute; top: 1rem; right: 1rem; opacity: 0.1; transform: scale(2); }
        
        /* --- BOUTONS NAVIGATION (DESIGN AM√âLIOR√â) --- */
        @keyframes pulse-border {
            0% { border-color: var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            50% { border-color: var(--blue); box-shadow: 0 0 12px rgba(37, 99, 235, 0.25); }
            100% { border-color: var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        }

        .btn { 
            padding: 0.6rem 1.2rem; 
            border-radius: 0.75rem; 
            border: 1px solid var(--border); 
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-body) 100%);
            color: var(--text-muted); 
            cursor: pointer; 
            font-weight: 700; 
            display: flex; align-items: center; gap: 0.5rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            letter-spacing: 0.02em;
        }

        /* Effet constant sur les boutons inactifs */
        .btn:not(.active):not(:hover) {
            animation: pulse-border 3s infinite ease-in-out;
        }

        .btn:hover { 
            background: #fff; 
            border-color: var(--blue);
            color: var(--blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.15);
            animation: none;
        }

        .btn.active { 
            background: linear-gradient(135deg, var(--blue), var(--indigo)); 
            color: white; 
            border-color: transparent; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            transform: scale(1.05);
            animation: none;
            z-index: 10;
        }

        nav { position: sticky; top: 0; z-index: 50; background: var(--nav-bg); border-bottom: 1px solid var(--border); padding: 0.75rem 0; backdrop-filter: blur(8px); }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg-body); color: var(--text-muted); padding: 0.75rem; text-transform: uppercase; font-size: 0.75rem; text-align: center; border-bottom: 1px solid var(--border); }
        td { padding: 0.5rem; border: 1px solid var(--border); text-align: center; }
        .td-left { text-align: left; }

        /* Typography */
        .text-xs { font-size: 0.75rem; } .text-sm { font-size: 0.875rem; } .text-lg { font-size: 1.125rem; } .text-2xl { font-size: 1.5rem; } .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: 700; } .uppercase { text-transform: uppercase; }
        
        /* Colors */
        .text-blue { color: var(--blue); } .bg-blue-soft { background: var(--blue-light); color: var(--blue-text); }
        .text-indigo { color: var(--indigo); }
        .text-emerald { color: var(--emerald); }
        .text-purple { color: var(--purple); } .bg-purple-soft { background: var(--purple-light); color: var(--purple-text); }
        .text-orange { color: var(--orange); } .bg-orange-soft { background: var(--orange-light); color: var(--orange-text); }
        .text-red { color: var(--red); } .bg-red-soft { background: var(--red-light); color: var(--red-text); }
        .text-teal { color: var(--teal); }

        /* Elements */
        select { width: 100%; text-align: center; text-align-last: center; border: none; font-weight: bold; cursor: pointer; padding: 4px; border-radius: 4px; appearance: none; -webkit-appearance: none; }
        .c-NX01 { background: var(--c-nx01); color: var(--t-nx01); }
        .c-J60F { background: var(--c-j60f); color: var(--t-j60f); }
        .c-JFP { background: var(--c-jfp); color: var(--t-jfp); }
        .c-JR { background: var(--c-jr); color: var(--t-jr); }
        .c-JMC { background: var(--c-jmc); color: var(--t-jmc); }
        .c-JR24 { background: var(--c-jr24); color: var(--t-jr24); }
        .c-MR1 { background: var(--c-mr1); color: var(--t-mr1); }
        .c-Vide { background: var(--c-void); color: var(--t-void); }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; margin: 2px; }
        .badge-work { background: var(--blue-light); color: var(--blue-text); border: 1px solid #dbeafe; }
        .badge-rest { background: var(--emerald-light); color: var(--emerald-text); border: 1px solid #d1fae5; }
        
        .comp-ok { color: var(--emerald); font-weight: bold; }
        .comp-err { color: var(--red); font-weight: bold; }
        .comp-neutral { color: var(--text-muted); }

        /* Icons */
        svg { width: 1.25rem; height: 1.25rem; fill: currentColor; }
        .icon-lg { width: 2.5rem; height: 2.5rem; }

    </style>
</head>
<body>

<nav>
    <div class="container flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div style="background:var(--blue); color:white; padding:6px; border-radius:6px;">
                <svg viewBox="0 0 512 512"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96z"/></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg" style="line-height:1">Simulateur Grilles</h1>
                <span class="text-xs text-muted">Version ADP Secure</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button class="btn active" id="btn-grille21" onclick="switchTab('grille21')">Grille 21</button>
            <button class="btn" id="btn-2022" onclick="switchTab('2022')">Grille 14</button>
            <button class="btn" id="btn-projet" onclick="switchTab('projet')">Grille 17</button>
            <button class="btn" id="btn-compare" onclick="switchTab('compare')">Comparateur</button>
            <button class="btn" onclick="document.documentElement.classList.toggle('dark')" style="padding:0.6rem; border-radius:50%; animation:none;">üåó</button>
        </div>
    </div>
</nav>

<main class="container mt-4">

    <!-- ALERTS -->
    <div id="alert-box" class="card mb-4 hidden bg-red-soft" style="border-left:4px solid var(--red)">
        <div class="flex items-center gap-2 font-bold text-red">
            <svg viewBox="0 0 512 512"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/></svg>
            R√®gles M√©tier Non Respect√©es
        </div>
        <ul id="alert-list" class="mt-2 text-red-text" style="padding-left:1.5rem"></ul>
    </div>

    <!-- OPTIMIZATION -->
    <div id="optim-box" class="card mb-8 hidden flex justify-between items-center bg-blue-soft" style="border:1px solid var(--blue)">
        <div class="flex items-center gap-4">
            <div style="background:white; padding:8px; border-radius:50%"><svg class="text-indigo" viewBox="0 0 512 512"><path d="M16 192.1l0 127.8c0 53 43 96 96 96c1.6 0 3.2 0 4.8 0l-5.6 5.6c-13.4 13.4-15.6 34-5.3 49.9s29.7 21 46.8 12.5L255.4 432H400c53 0 96-43 96-96l0-16.1c0-53-43-96-96-96l-46.1 0 0-31.8c0-53-43-96-96-96L112 96c-53 0-96 43-96 96.1z"/></svg></div>
            <div>
                <h3 class="font-bold text-indigo">Optimisation Ligne 12 (Triangulaire)</h3>
                <div class="text-sm text-indigo">Appliquer l'√©change : L12 (Jeu:NX01, Ven:NX01) ‚Üî L13 (Jeu:JR) ‚Üî L8 (Ven:J60F)</div>
            </div>
        </div>
        <button onclick="applyTriangularSwap()" class="btn" style="background:var(--indigo); color:white; animation:none;">Appliquer</button>
    </div>

    <!-- MAIN STATS -->
    <div id="stats-main" class="grid grid-4 mb-8">
        <div class="card">
            <div class="stat-icon-bg text-blue"><svg viewBox="0 0 512 512"><path d="M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Dur√©e Hebdo Moyenne</dt>
            <dd class="mt-2 text-3xl font-bold" id="disp-hebdo">--:--</dd>
            <div class="mt-2 text-xs text-muted"><span class="bg-blue-soft px-1 rounded">Cible 37h30</span> 525h/cycle</div>
        </div>
        <div class="card">
            <div class="stat-icon-bg text-indigo"><svg viewBox="0 0 384 512"><path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9 0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Charge Nuit / Agent</dt>
            <div class="flex items-baseline mt-2 gap-2">
                <dd class="text-3xl font-bold text-indigo" id="disp-nuits-nb">--</dd>
                <span class="text-sm font-bold text-indigo">nuits</span>
                <span class="text-muted">|</span>
                <dd class="text-2xl font-bold text-indigo" id="disp-nuits-h">--h</dd>
            </div>
            <p class="mt-2 text-xs text-muted">Projection 52 sem</p>
        </div>
        <div class="card">
            <div class="stat-icon-bg text-emerald"><svg viewBox="0 0 640 512"><path d="M48 0C21.5 0 0 21.5 0 48V368c0 26.5 21.5 48 48 48H64c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H48z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Fr√©quence Vacations</dt>
            <div class="flex items-baseline mt-2 gap-2">
                <dd class="text-3xl font-bold text-emerald" id="disp-vacs">--</dd>
                <span class="text-sm text-muted">/ sem</span>
            </div>
            <p class="mt-2 text-xs font-bold text-emerald" id="disp-vacs-an">-- vacations / an</p>
        </div>
        <div class="card">
            <div class="stat-icon-bg text-purple"><svg viewBox="0 0 512 512"><path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM337 209L209 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L303 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Total Major√© (Moy/Mois)</dt>
            <dd class="mt-2 text-3xl font-bold text-purple" id="disp-majo">--:--</dd>
            <p class="mt-2 text-xs text-muted">Nuit + Dimanche</p>
        </div>
    </div>

    <!-- SOCIAL STATS -->
    <div id="stats-social" class="grid grid-2 mb-8">
        <div class="card flex justify-between items-center" style="border-top:4px solid var(--orange)">
            <div>
                <dt class="text-xs font-bold text-muted uppercase">Dimanches Travaill√©s</dt>
                <div class="flex items-baseline gap-2 mt-1">
                    <dd class="text-3xl font-bold text-orange" id="d-trav-nb">--</dd> <span class="text-muted text-sm">j / <span id="d-trav-h">--</span>h</span>
                </div>
            </div>
        </div>
        <div class="card flex justify-between items-center" style="border-top:4px solid var(--teal)">
            <div>
                <dt class="text-xs font-bold text-muted uppercase">Dimanches Repos</dt>
                <div class="flex items-baseline gap-2 mt-1">
                    <dd class="text-3xl font-bold text-teal" id="d-repos-nb">--</dd> <span class="text-muted text-sm">j / <span id="d-repos-h">--</span>h</span>
                </div>
            </div>
        </div>
        <div class="card flex justify-between items-center" style="border-top:4px solid var(--emerald)">
             <div>
                <dt class="text-xs font-bold text-muted uppercase">Week-ends Complets</dt>
                <dd class="text-3xl font-bold text-emerald mt-1" id="d-we">--</dd>
                <span class="text-xs text-muted">Samedi & Dimanche OFF</span>
            </div>
        </div>
    </div>

    <!-- SERIES (RHYTHMS) - RESTORED -->
    <div id="stats-rhythm" class="grid grid-2 mb-8">
        <div class="card" style="border-left:4px solid var(--blue)">
            <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200">
                <dt class="text-xs font-bold text-muted uppercase">S√©ries de Vacations (An)</dt>
                <dd class="text-2xl font-bold text-blue" id="disp-series-vac-total">--</dd>
            </div>
            <div id="disp-series-vac-detail" class="flex flex-wrap gap-2"></div>
            <p class="text-xs text-muted mt-2">S√©quences de travail cons√©cutives</p>
        </div>
        <div class="card" style="border-left:4px solid var(--emerald)">
            <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200">
                <dt class="text-xs font-bold text-muted uppercase">S√©ries de Repos (An)</dt>
                <dd class="text-2xl font-bold text-emerald" id="disp-series-repos-total">--</dd>
            </div>
            <div id="disp-series-repos-detail" class="flex flex-wrap gap-2"></div>
            <p class="text-xs text-muted mt-2">S√©quences de repos cons√©cutives</p>
        </div>
    </div>

    <!-- GRILLE VIEW -->
    <div id="view-grid" class="card mb-8">
        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
            <h3 class="font-bold text-lg" id="grid-title">Grille Actuelle</h3>
            <div class="text-xs font-medium text-muted bg-gray-100 px-3 py-1 rounded-full border">Max 42h/sem</div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Ligne</th><th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
                        <th>Nb Vac</th><th>Dur√©e</th><th>H. Nuit</th><th>H. Dim</th><th>Total Majo</th>
                    </tr>
                </thead>
                <tbody id="grid-body"></tbody>
            </table>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-4 justify-center text-xs text-muted">
            <span class="font-bold">L√©gende:</span>
            <span class="flex items-center gap-1"><span class="c-NX01 w-3 h-3 block"></span> NX01</span>
            <span class="flex items-center gap-1"><span class="c-J60F w-3 h-3 block"></span> J60F</span>
            <span class="flex items-center gap-1"><span class="c-JR w-3 h-3 block"></span> JR</span>
        </div>
    </div>

    <!-- RULES CHECKER (RESTORED) -->
    <div id="view-rules" class="card mb-8">
        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <svg class="text-emerald" viewBox="0 0 512 512"><path d="M173.9 439.4l-166.4-166.4c-10-10-10-26.2 0-36.2l36.2-36.2c10-10 26.2-10 36.2 0L192 312.7 432.1 72.6c10-10 26.2-10 36.2 0l36.2 36.2c10 10 10 26.2 0 36.2L210.1 439.4c-10 10-26.2 10-36.2 0z"/></svg>
                Contr√¥le des R√®gles (DESY PDS-FDS)
            </h3>
            <span class="text-xs font-bold bg-gray-200 px-3 py-1 rounded-full" id="rules-label">Grille 21</span>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th class="td-left">Comp√©tence</th><th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
                    </tr>
                </thead>
                <tbody id="rules-body"></tbody>
            </table>
        </div>
    </div>

    <!-- COMPARATOR (RESTORED FULLY) -->
    <div id="view-compare" class="card hidden">
        <div class="mb-4 pb-4 border-b border-gray-200">
            <h3 class="font-bold text-lg">Comparatif Global</h3>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th class="td-left">Indicateur</th><th>Grille 14 (2022)</th><th>Grille 17 (Projet)</th><th>Grille 21 (Cible)</th>
                    </tr>
                </thead>
                <tbody id="compare-body"></tbody>
            </table>
        </div>
        <div class="mt-4 bg-blue-soft p-4 rounded text-xs text-blue-text border border-blue-200">
            <strong>Note sur les scores :</strong> Physio = (Nuits + Vacations)/an. Social = (WE/Nuit Vendredi/F√©ri√© + Vacations)/an.
        </div>
    </div>

</main>

<script>
    // --- DATA & CONFIG ---
    const HORAIRES = {
        "J60F": { debut: 6, fin: 18, duree: 12.0, nuit: 0, split: false },
        "JMC":  { debut: 6, fin: 18, duree: 12.0, nuit: 0, split: false },
        "JR":   { debut: 6, fin: 18, duree: 12.0, nuit: 0, split: false },
        "JR24": { debut: 6, fin: 16.5, duree: 10.5, nuit: 0, split: false },
        "NX01": { debut: 18, fin: 30, duree: 12.0, nuit: 8, split: true, splitHours: [6, 6], nightSplit: [2, 6] },
        "MR1":  { debut: 6, fin: 14.5, duree: 8.5, nuit: 0, split: false },
        "JFP":  { debut: 6, fin: 18, duree: 12.0, nuit: 0, split: false },
        "":     { debut: 0, fin: 0, duree: 0, nuit: 0, split: false }
    };

    const CONSTRAINTS_2022 = { "J60F": [2, 2, 2, 2, 2, 2, 2], "JMC": [1, 0, 0, 0, 0, 1, 0], "JR": [1, 2, 2, 2, 2, 1, 2], "JR24": [2, 0, 0, 0, 0, 0, 0], "NX01": [2, 2, 2, 2, 2, 2, 2] };
    const CONSTRAINTS_PROJET = { "J60F": [3, 3, 3, 3, 3, 3, 3], "JFP": [0, 2, 0, 0, 0, 0, 0], "JR": [2, 1, 2, 3, 1, 1, 4], "MR1": [1, 0, 1, 0, 0, 1, 0], "NX01": [2, 2, 2, 2, 2, 2, 2] };
    const CONSTRAINTS_GRILLE21 = { "J60F": [3, 3, 3, 3, 3, 3, 3], "NX01": [3, 3, 3, 3, 3, 3, 3], "JFP": [0, 2, 0, 0, 0, 0, 0], "JR": [0, 0, 0, 0, 0, 0, 0], "JR24": [0, 0, 0, 0, 0, 0, 0] };

    const DATA_2022 = [
        ["NX01", "", "", "", "NX01", "NX01", ""], ["", "", "JR", "JR", "JR", "", ""], ["", "NX01", "NX01", "", "", "", "JR"], ["JMC", "", "", "", "", "J60F", "J60F"], ["JR24", "", "", "J60F", "J60F", "", ""], ["", "J60F", "J60F", "NX01", "", "", ""], ["J60F", "JR", "", "", "", "JR", "NX01"],
        ["NX01", "", "", "", "NX01", "NX01", ""], ["", "", "J60F", "J60F", "J60F", "", ""], ["", "NX01", "NX01", "", "", "", "JR"], ["JR", "", "", "", "", "J60F", "J60F"], ["JR24", "", "", "JR", "JR", "", ""], ["", "J60F", "JR", "NX01", "", "", ""], ["J60F", "JR", "", "", "", "JMC", "NX01"]
    ];

    const DATA_PROJET = [
        ["NX01", "", "", "", "", "JR", "JR"], ["", "", "MR1", "JR", "JR", "", ""], ["", "JR", "JR", "", "", "", "JR"], ["JR", "", "", "", "", "J60F", "J60F"], ["JR", "", "", "J60F", "J60F", "", ""], ["", "J60F", "J60F", "JR", "", "", ""], ["J60F", "J60F", "", "", "", "NX01", "NX01"],
        ["", "", "", "J60F", "NX01", "NX01", ""], ["", "", "J60F", "J60F", "J60F", "", ""], ["", "NX01", "NX01", "", "", "", "JR"], ["J60F", "JFP", "", "", "", "J60F", "NX01"], ["NX01", "", "", "JR", "J60F", "", ""], ["", "J60F", "JR", "NX01", "", "", ""], ["MR1", "JFP", "", "", "", "MR1", "J60F"], ["J60F", "", "", "", "", "J60F", "J60F"], ["", "", "J60F", "NX01", "NX01", "", ""], ["", "NX01", "NX01", "", "", "", "JR"]
    ];

    let DATA_GRILLE21_TEMP = JSON.parse(JSON.stringify(DATA_2022));
    for(let i=0; i<7; i++) DATA_GRILLE21_TEMP.push([...DATA_2022[i]]);
    for(let r=0; r<DATA_GRILLE21_TEMP.length; r++) {
        for(let c=0; c<DATA_GRILLE21_TEMP[r].length; c++) {
            if(DATA_GRILLE21_TEMP[r][c] === 'JMC' || DATA_GRILLE21_TEMP[r][c] === 'MR1') DATA_GRILLE21_TEMP[r][c] = 'JR';
        }
    }
    if(DATA_GRILLE21_TEMP.length > 6) DATA_GRILLE21_TEMP[6][1] = 'JFP';
    if(DATA_GRILLE21_TEMP.length > 13) DATA_GRILLE21_TEMP[13][1] = 'JFP';
    const DATA_GRILLE21 = DATA_GRILLE21_TEMP;

    let currentMode = 'grille21';
    let activeData = JSON.parse(JSON.stringify(DATA_GRILLE21));

    // --- CALCULATION ENGINE (PREMIUM EXACT COPY) ---
    function calculateStats(grid) {
        const nbLignes = grid.length;
        let violations = [];
        let lineDurations = new Array(nbLignes).fill(0);
        let lineNights = new Array(nbLignes).fill(0);
        let lineVacs = new Array(nbLignes).fill(0);
        let lineSundays = new Array(nbLignes).fill(0);
        let lineMajo = new Array(nbLignes).fill(0);
        let totalHeures = 0, totalNuit = 0, totalDimanche = 0, totalMajo = 0, totalVacations = 0;
        let countDimTrav = 0, countWERepos = 0, countNuits = 0, scoreSocial = 0;
        let flatSchedule = [];
        grid.forEach(row => row.forEach(code => flatSchedule.push(code)));

        // Series
        let simpleRuns = [];
        if (flatSchedule.length > 0) {
            let currentRun = { type: !!flatSchedule[0], count: 1 };
            for(let i=1; i<flatSchedule.length; i++) {
                if(!!flatSchedule[i] === currentRun.type) currentRun.count++;
                else { simpleRuns.push(currentRun); currentRun = { type: !!flatSchedule[i], count: 1 }; }
            }
            simpleRuns.push(currentRun);
            if(simpleRuns.length > 1 && simpleRuns[0].type === simpleRuns[simpleRuns.length-1].type) simpleRuns[0].count += simpleRuns.pop().count;
        }
        simpleRuns.forEach(s => {
            if(s.type && s.count === 1) violations.push("Vacation isol√©e d√©tect√©e");
            if(s.type && s.count > 3) violations.push("S√©rie de +3 vacations");
        });

        // Repos & Logic
        for(let i=0; i<flatSchedule.length; i++) {
            let code = flatSchedule[i]; if(!code) continue;
            let nextIdx = -1;
            for(let j=1; j<flatSchedule.length; j++) if(flatSchedule[(i+j)%flatSchedule.length]) { nextIdx=(i+j); break; }
            if(nextIdx !== -1) {
                let nextCode = flatSchedule[nextIdx%flatSchedule.length];
                let gapDays = nextIdx - i;
                let restTime = (HORAIRES[nextCode].debut + (gapDays*24)) - HORAIRES[code].fin;
                if(gapDays===1 && restTime<12) violations.push(`Repos jour < 12h: ${code}->${nextCode} (${restTime}h)`);
                if(gapDays>1 && restTime<48) violations.push(`Bloc Repos < 48h`);
            }
        }
        
        // Loop Rows
        for (let r = 0; r < nbLignes; r++) {
            if(!grid[r][5] && !grid[r][6]) countWERepos++;
            if(grid[r][6]) countDimTrav++;
            for (let c = 0; c < 7; c++) {
                let code = grid[r][c];
                if (code && HORAIRES[code]) {
                    let hDef = HORAIRES[code];
                    lineVacs[r]++; totalVacations++;
                    if (code === 'NX01') countNuits++;
                    if (c === 4 && code === 'NX01') scoreSocial++;
                    if (c === 5 || c === 6) scoreSocial++;

                    if (!hDef.split) {
                        lineDurations[r] += hDef.duree; lineNights[r] += hDef.nuit; totalHeures += hDef.duree; totalNuit += hDef.nuit;
                        let sun = (c===6)?hDef.duree:0; totalDimanche+=sun; lineSundays[r]+=sun;
                        let maj = hDef.nuit+sun; lineMajo[r]+=maj; totalMajo+=maj;
                    } else {
                        // Split
                        let d1=hDef.splitHours[0], n1=hDef.nightSplit[0];
                        lineDurations[r]+=d1; lineNights[r]+=n1; totalHeures+=d1; totalNuit+=n1;
                        let sun1=(c===6)?d1:0; totalDimanche+=sun1; lineSundays[r]+=sun1;
                        // Correct calculation for overlapping hours majoration
                        let overlap1 = (n1 > 0 && sun1 > 0) ? Math.min(n1, sun1) : 0;
                        let majo1 = n1 + sun1 - overlap1;
                        lineMajo[r] += majo1; totalMajo += majo1;

                        let d2=hDef.splitHours[1], n2=hDef.nightSplit[1];
                        let tLine = (c<6)?r:(r+1)%nbLignes;
                        lineDurations[tLine]+=d2; lineNights[tLine]+=n2; totalHeures+=d2; totalNuit+=n2;
                        let sun2=(c===5)?d2:0; 
                        if(c===5){ totalDimanche+=d2; lineSundays[tLine]+=d2; }
                        let overlap2 = (n2 > 0 && sun2 > 0) ? Math.min(n2, sun2) : 0;
                        let majo2 = n2 + sun2 - overlap2;
                        lineMajo[tLine] += majo2; totalMajo += majo2;
                    }
                }
            }
        }

        const vacSemaine = totalVacations / nbLignes;
        const vacAn = vacSemaine * 52;
        
        // Series Counts
        const seriesVacCounts = {};
        const seriesReposCounts = {};
        simpleRuns.forEach(s => {
            if(s.type) seriesVacCounts[s.count] = (seriesVacCounts[s.count]||0)+1;
            else seriesReposCounts[s.count] = (seriesReposCounts[s.count]||0)+1;
        });
        
        return {
            violations, totalHeures, totalNuit, totalDimanche, totalMajo, totalVacations,
            hebdo: totalHeures / nbLignes,
            vacSemaine, vacAn,
            dimancheMois: (totalDimanche * (52/12)) / nbLignes,
            majoMois: (totalMajo * (52/12)) / nbLignes,
            dimTravAn: (countDimTrav * 52) / nbLignes,
            dimReposAn: 52 - ((countDimTrav * 52) / nbLignes),
            weReposAn: (countWERepos * 52) / nbLignes,
            nuitsAn: (countNuits * 52) / nbLignes,
            heuresNuitAn: (totalNuit * 52) / nbLignes,
            dimancheAnHours: (totalDimanche * 52) / nbLignes,
            dimReposAnHours: (52 - ((countDimTrav * 52) / nbLignes)) * 24,
            scorePhysioAn: ((countNuits * 52) / nbLignes) + vacAn,
            scoreSocialAn: ((scoreSocial * 52) / nbLignes) + vacAn,
            lineDurations, lineNights, lineVacs, lineSundays, lineMajo, nbLignes,
            seriesVacCounts, seriesReposCounts, cyclesPerYear: 52 / nbLignes,
            totalSeriesVac: Object.values(seriesVacCounts).reduce((a,b)=>a+b,0),
            totalSeriesRepos: Object.values(seriesReposCounts).reduce((a,b)=>a+b,0)
        };
    }

    // --- DISPLAY UTILS ---
    function formatTime(d) {
        let h = Math.floor(Math.abs(d)); let m = Math.round((Math.abs(d)-h)*60);
        if(m===60){h++;m=0;} return `${d<0?"-":""}${h}h${m<10?'0':''}${m}`;
    }

    function renderConstraints(grid, constraints) {
        const tb = document.getElementById('rules-body'); tb.innerHTML='';
        const counts = {}; Object.keys(constraints).forEach(c => counts[c] = [0,0,0,0,0,0,0]);
        grid.forEach(row => row.forEach((code, i) => { if(code && counts[code]) counts[code][i]++; }));
        
        Object.keys(constraints).forEach(code => {
            const tr = document.createElement('tr');
            let html = `<td class="td-left font-bold flex items-center"><span class="c-${code} w-3 h-3 block mr-2 rounded-sm"></span>${code}</td>`;
            for(let i=0; i<7; i++) {
                const c = counts[code][i], t = constraints[code][i];
                let cls = (t>0) ? (c===t?"comp-ok":"comp-err") : "comp-neutral";
                html += `<td><span class="${cls}">${c}/${t}</span></td>`;
            }
            tr.innerHTML = html; tb.appendChild(tr);
        });
    }

    function renderCompare() {
        const s14=calculateStats(DATA_2022), s17=calculateStats(DATA_PROJET), s21=calculateStats(DATA_GRILLE21);
        const tb=document.getElementById('compare-body'); tb.innerHTML='';
        
        const diff = (a,b,inv=false) => {
            // FIX: Round BEFORE Diff to match original display
            let val = Math.round(a) - Math.round(b);
            let txt = (val>0?"+":"")+val;
            if(Math.abs(val)<0.1) txt="=";
            let c = (val>0)?(inv?"text-red":"text-emerald"):(val<0?(inv?"text-emerald":"text-red"):"text-muted");
            return `<span class="text-xs ${c} ml-1">(${txt})</span>`;
        };
        
        const diffTime = (a,b) => {
            let val = a-b;
            let c = (val>0)?"text-red":(val<0?"text-emerald":"text-muted");
            return `<span class="text-xs ${c} ml-1">(${formatTime(val)})</span>`;
        }

        const row = (l, v1, v2, v3) => `<tr><td class="td-left font-bold text-muted">${l}</td><td class="font-bold">${v1}</td><td class="font-bold">${v2}</td><td class="font-bold">${v3}</td></tr>`;

        // Exact original rows logic
        tb.innerHTML += row("Dur√©e Hebdo", formatTime(s14.hebdo), formatTime(s17.hebdo)+diffTime(s17.hebdo,s14.hebdo), formatTime(s21.hebdo)+diffTime(s21.hebdo,s14.hebdo));
        tb.innerHTML += row("Vacations/An", Math.round(s14.vacAn), Math.round(s17.vacAn)+diff(s17.vacAn,s14.vacAn,true), Math.round(s21.vacAn)+diff(s21.vacAn,s14.vacAn,true));
        tb.innerHTML += row("Total Nuits/An", Math.round(s14.heuresNuitAn)+'h', Math.round(s17.heuresNuitAn)+'h'+diff(s17.heuresNuitAn,s14.heuresNuitAn), Math.round(s21.heuresNuitAn)+'h'+diff(s21.heuresNuitAn,s14.heuresNuitAn));
        tb.innerHTML += row("Dim Repos (An)", Math.round(s14.dimReposAn), Math.round(s17.dimReposAn)+diff(s17.dimReposAn,s14.dimReposAn), Math.round(s21.dimReposAn)+diff(s21.dimReposAn,s14.dimReposAn));
        tb.innerHTML += row("WE Complets (An)", Math.round(s14.weReposAn), Math.round(s17.weReposAn)+diff(s17.weReposAn,s14.weReposAn), Math.round(s21.weReposAn)+diff(s21.weReposAn,s14.weReposAn));
        tb.innerHTML += row("Total Major√© (Mois)", formatTime(s14.majoMois), formatTime(s17.majoMois)+diffTime(s17.majoMois,s14.majoMois), formatTime(s21.majoMois)+diffTime(s21.majoMois,s14.majoMois));
        tb.innerHTML += row("Score Physio", Math.round(s14.scorePhysioAn), Math.round(s17.scorePhysioAn)+diff(s17.scorePhysioAn,s14.scorePhysioAn,true), Math.round(s21.scorePhysioAn)+diff(s21.scorePhysioAn,s14.scorePhysioAn,true));
        tb.innerHTML += row("Score Social", Math.round(s14.scoreSocialAn), Math.round(s17.scoreSocialAn)+diff(s17.scoreSocialAn,s14.scoreSocialAn,true), Math.round(s21.scoreSocialAn)+diff(s21.scoreSocialAn,s14.scoreSocialAn,true));
    }

    function renderGrid() {
        const stats = calculateStats(activeData);
        // Stats Cards
        document.getElementById('disp-hebdo').innerText = formatTime(stats.hebdo);
        document.getElementById('disp-nuits-nb').innerText = Math.round(stats.nuitsAn);
        document.getElementById('disp-nuits-h').innerText = Math.round(stats.heuresNuitAn)+'h';
        document.getElementById('disp-vacs').innerText = stats.vacSemaine.toFixed(2);
        document.getElementById('disp-vacs-an').innerText = Math.round(stats.vacAn) + " / an";
        document.getElementById('disp-majo').innerText = formatTime(stats.majoMois);
        // Social
        document.getElementById('d-trav-nb').innerText = Math.round(stats.dimTravAn);
        document.getElementById('d-trav-h').innerText = Math.round(stats.dimancheAnHours) + 'h';
        document.getElementById('d-repos-nb').innerText = Math.round(stats.dimReposAn);
        document.getElementById('d-repos-h').innerText = Math.round(stats.dimReposAnHours) + 'h';
        document.getElementById('d-we').innerText = Math.round(stats.weReposAn);
        
        // Series Display (Restored)
        const f = stats.cyclesPerYear;
        // Vacation Series
        document.getElementById('disp-series-vac-total').innerText = Math.round(stats.totalSeriesVac * f);
        const vacDetail = document.getElementById('disp-series-vac-detail'); vacDetail.innerHTML = '';
        Object.keys(stats.seriesVacCounts).sort((a,b)=>a-b).forEach(k => {
             if(Math.round(stats.seriesVacCounts[k]*f) > 0)
                vacDetail.innerHTML += `<span class="badge badge-work">${Math.round(stats.seriesVacCounts[k]*f)}x ${k}j</span>`;
        });
        // Rest Series
        document.getElementById('disp-series-repos-total').innerText = Math.round(stats.totalSeriesRepos * f);
        const reposDetail = document.getElementById('disp-series-repos-detail'); reposDetail.innerHTML = '';
        Object.keys(stats.seriesReposCounts).sort((a,b)=>a-b).forEach(k => {
            if(Math.round(stats.seriesReposCounts[k]*f) > 0)
                reposDetail.innerHTML += `<span class="badge badge-rest">${Math.round(stats.seriesReposCounts[k]*f)}x ${k}j</span>`;
        });


        // Grid
        const tb = document.getElementById('grid-body'); tb.innerHTML='';
        activeData.forEach((row, r) => {
            let html = `<td class="font-bold bg-gray-50">${r+1}</td>`;
            row.forEach((c, i) => {
                let opts = `<option value="">--</option>`;
                Object.keys(HORAIRES).forEach(k => { if(k) opts+=`<option value="${k}" ${c===k?'selected':''}>${k}</option>` });
                html += `<td><select class="c-${c||'Vide'}" onchange="updateCell(${r},${i},this.value)">${opts}</select></td>`;
            });
            let cls = stats.lineDurations[r]>42 ? 'text-red font-bold' : 'text-emerald font-bold';
            html += `<td>${stats.lineVacs[r]}</td><td class="${cls}">${formatTime(stats.lineDurations[r])}</td><td class="text-blue">${formatTime(stats.lineNights[r])}</td><td class="text-orange">${formatTime(stats.lineSundays[r])}</td><td class="text-purple font-bold">${formatTime(stats.lineMajo[r])}</td>`;
            let tr = document.createElement('tr'); tr.innerHTML = html; tb.appendChild(tr);
        });

        // Alerts
        const ab = document.getElementById('alert-box');
        if(stats.violations.length>0) { ab.classList.remove('hidden'); document.getElementById('alert-list').innerHTML=stats.violations.map(v=>`<li>${v}</li>`).join(''); }
        else ab.classList.add('hidden');

        // Constraints
        if(currentMode==='2022') renderConstraints(activeData, CONSTRAINTS_2022);
        else if(currentMode==='projet') renderConstraints(activeData, CONSTRAINTS_PROJET);
        else if(currentMode==='grille21') renderConstraints(activeData, CONSTRAINTS_GRILLE21);

        if(!document.getElementById('view-compare').classList.contains('hidden')) renderCompare();
    }

    function updateCell(r, c, v) { activeData[r][c]=v; renderGrid(); }
    
    function switchTab(t) {
        currentMode = t;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        if(document.getElementById('btn-'+t)) document.getElementById('btn-'+t).classList.add('active');
        
        ['stats-main','stats-social','stats-rhythm','view-grid','view-rules','view-compare','optim-box'].forEach(i=>document.getElementById(i).classList.add('hidden'));

        if(t==='compare') {
            document.getElementById('view-compare').classList.remove('hidden');
            renderCompare();
        } else {
            ['stats-main','stats-social','stats-rhythm','view-grid','view-rules'].forEach(i=>document.getElementById(i).classList.remove('hidden'));
            if(t==='2022') { activeData=JSON.parse(JSON.stringify(DATA_2022)); document.getElementById('grid-title').innerText="Grille 14 (2022)"; document.getElementById('rules-label').innerText="Grille 14"; }
            if(t==='projet') { activeData=JSON.parse(JSON.stringify(DATA_PROJET)); document.getElementById('grid-title').innerText="Grille 17 (Projet)"; document.getElementById('rules-label').innerText="Grille 17"; document.getElementById('optim-box').classList.remove('hidden'); }
            if(t==='grille21') { activeData=JSON.parse(JSON.stringify(DATA_GRILLE21)); document.getElementById('grid-title').innerText="Grille 21 (Cible)"; document.getElementById('rules-label').innerText="Grille 21"; }
            renderGrid();
        }
    }

    function applyTriangularSwap() {
        if(currentMode!=='projet') return;
        activeData[11][3]='NX01'; activeData[11][4]='NX01'; activeData[12][3]='JR'; activeData[7][4]='J60F';
        renderGrid(); alert("Optimisation appliqu√©e");
    }

    // Init
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    renderGrid();
</script>
</body>
</html>